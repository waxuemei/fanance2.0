<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>许氏轮胎店</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        body { -webkit-tap-highlight-color: transparent; }
        .pb-safe { padding-bottom: calc(5rem + env(safe-area-inset-bottom)); }
        @media (min-width: 768px) { .pb-safe { padding-bottom: 0; } }
        /* 错误显示器样式 */
        #global-error-display { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; overflow: auto; color: red; font-family: monospace; }
    </style>
    <!-- 错误捕捉脚本：白屏时显示具体报错 -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            var display = document.getElementById('global-error-display');
            if(display) {
                display.style.display = 'block';
                display.innerHTML += '<h3>⚠️ 程序发生错误:</h3><p>' + msg + '</p><p>位置: ' + url + ':' + line + ':' + col + '</p><pre>' + (error ? error.stack : '') + '</pre>';
            }
        };
        window.addEventListener('unhandledrejection', function(event) {
            var display = document.getElementById('global-error-display');
            if(display) {
                display.style.display = 'block';
                display.innerHTML += '<h3>⚠️ 未处理的异步错误:</h3><p>' + event.reason + '</p>';
            }
        });
    </script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"
      }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
    <div id="global-error-display"></div>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc, serverTimestamp, getDoc, runTransaction, where } from 'firebase/firestore';
        import { Users, Wrench, PackagePlus, History, TrendingUp, LogOut, AlertTriangle, Trash2, Plus, Minus, Search, ArrowRight, ShieldCheck, UserPlus, CheckCircle, XCircle, Lock, Eye, EyeOff, X, Settings, Cloud } from 'lucide-react';

        // --- 核心配置逻辑 (已填入您的配置) ---
        const getStoredConfig = () => {
            // 1. 优先：您提供的硬编码配置
            const manualConfig = {
                apiKey: "AIzaSyCQeU-r_iUCoq0WWt86pXIVBYuY4Qt1lFc",
                authDomain: "finance123-c01a0.firebaseapp.com",
                projectId: "finance123-c01a0",
                storageBucket: "finance123-c01a0.firebasestorage.app",
                messagingSenderId: "519457301228",
                appId: "1:519457301228:web:cc713b1fc1fca47ed0bbc9",
                measurementId: "G-H0BW472LGV"
            };
            
            // 如果是在 Canvas 预览环境，尝试使用环境变量
            if (typeof __firebase_config !== 'undefined') {
                try {
                    return JSON.parse(__firebase_config);
                } catch(e) {
                    console.log("Canvas config parse error, using manual config");
                }
            }

            return manualConfig;
        };

        const config = getStoredConfig();
        const BOSS_PIN = "8888";
        const UNDO_TIME_LIMIT_MS = 5 * 60 * 1000;
        const appUniqueId = typeof __app_id !== 'undefined' ? __app_id : 'xu-tire-shop-v1';

        // --- UI Components ---
        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-100 p-4 ${className}`}>{children}</div>;
        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false }) => {
            const base = "px-4 py-3 rounded-lg font-medium transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2";
            const vs = { primary: "bg-blue-600 text-white shadow-lg shadow-blue-200", outline: "border border-slate-200 text-slate-600" };
            return <button onClick={onClick} className={`${base} ${vs[variant] || vs.primary} ${className}`} disabled={disabled}>{children}</button>;
        };
        const Input = ({ label, value, onChange, type = "text", placeholder = "", disabled = false, inputMode }) => {
            const [show, setShow] = useState(false);
            const isPass = type === "password";
            return (
                <div className="mb-3">
                    <label className="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-1">{label}</label>
                    <div className="relative">
                        <input type={isPass && show ? "text" : type} inputMode={inputMode} value={value} onChange={e => onChange(e.target.value)} className="w-full p-3 border rounded-lg bg-white text-base focus:ring-2 focus:ring-blue-500/50 outline-none" placeholder={placeholder} disabled={disabled} style={{fontSize:'16px'}} />
                        {isPass && <button onClick={() => setShow(!show)} className="absolute right-3 top-3 text-slate-400 p-1">{show ? <EyeOff size={20}/> : <Eye size={20}/>}</button>}
                    </div>
                </div>
            );
        };

        // --- Main App Logic ---
        function Main() {
            if (!config || !config.apiKey) {
                return <div className="p-8 text-center text-red-500">❌ 错误：未找到 Firebase 配置，请检查 index.html 代码。</div>;
            }

            // 初始化 Firebase
            let app, auth, db;
            try {
                app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase Init Error:", e);
                return <div className="p-8 text-center text-red-500">❌ Firebase 初始化失败: {e.message}</div>;
            }

            return <TireShopApp app={app} auth={auth} db={db} />;
        }

        // --- Business App ---
        function TireShopApp({ app, auth, db }) {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [bossLocked, setBossLocked] = useState(false);
            const [inventory, setInventory] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [currentTab, setCurrentTab] = useState('dashboard');
            const [showLogin, setShowLogin] = useState(true);
            const [notification, setNotification] = useState(null);

            // Auth
            useEffect(() => {
                const initAuth = async () => { 
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth Error:", e);
                        // 如果自动登录失败，尝试匿名登录作为兜底
                        try { await signInAnonymously(auth); } catch(e2) { console.error("Anonymous Auth Failed:", e2); }
                    }
                };
                initAuth();
                
                return onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        const saved = localStorage.getItem('tireShopUser');
                        if (saved) {
                            const p = JSON.parse(saved);
                            if (p.role === 'boss') { setUser(p); setShowLogin(false); setBossLocked(true); }
                            else {
                                try {
                                    const snap = await getDoc(doc(db, 'artifacts', appUniqueId, 'public', 'data', 'users', p.name));
                                    if (snap.exists() && snap.data().status === 'approved') { setUser(p); setShowLogin(false); }
                                    else { localStorage.removeItem('tireShopUser'); setShowLogin(true); }
                                } catch(e) { 
                                    // 网络错误时不强制登出，允许离线查看（如果有缓存）
                                    console.log("Verify user status failed:", e);
                                    setUser(p); setShowLogin(false);
                                }
                            }
                        } else setShowLogin(true);
                    }
                    setLoading(false);
                });
            }, []);

            // Data
            useEffect(() => {
                if (!user || bossLocked) return;
                const unsubInv = onSnapshot(query(collection(db, 'artifacts', appUniqueId, 'public', 'data', 'inventory')), (s) => setInventory(s.docs.map(d => ({id:d.id,...d.data()}))));
                const unsubTx = onSnapshot(query(collection(db, 'artifacts', appUniqueId, 'public', 'data', 'transactions')), (s) => setTransactions(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>b.timestamp-a.timestamp)));
                return () => { unsubInv(); unsubTx(); };
            }, [user, bossLocked]);

            const showNotify = (msg, type = 'success') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };
            const handleLoginSuccess = (u) => { setUser(u); localStorage.setItem('tireShopUser', JSON.stringify(u)); setShowLogin(false); setBossLocked(false); setCurrentTab('dashboard'); };
            const handleLogout = () => { setUser(null); localStorage.removeItem('tireShopUser'); setShowLogin(true); setBossLocked(false); };

            // Logic
            const handleStockIn = async (brand, spec, qty, cost) => {
                try {
                    const q = parseInt(qty), c = parseFloat(cost);
                    const bid = `${brand.trim()}_${spec.trim()}`.replace(/[\s/]+/g, '_').toUpperCase();
                    const ref = doc(db, 'artifacts', appUniqueId, 'public', 'data', 'inventory', bid);
                    await runTransaction(db, async (t) => {
                        const snap = await t.get(ref);
                        let nq = q, navg = c;
                        if (snap.exists()) { const d = snap.data(); const cq = Number(d.quantity)||0; const ca = Number(d.avgCost)||0; nq = cq+q; navg = ((cq*ca)+(q*c))/nq; }
                        t.set(ref, { brand: brand.trim(), spec: spec.trim(), quantity: nq, avgCost: navg }, { merge: true });
                        t.set(doc(collection(db, 'artifacts', appUniqueId, 'public', 'data', 'transactions')), { type: 'stock_in', brand: brand.trim(), spec: spec.trim(), quantity: q, cost: c, totalCost: q*c, date: new Date().toISOString(), timestamp: Date.now(), operator: user.name });
                    });
                    showNotify(`入库成功: ${q}条`);
                } catch (e) { showNotify("入库失败: " + e.message, "error"); }
            };

            const handleSale = async (id, qty, price) => {
                try {
                    const q = parseInt(qty), p = parseFloat(price);
                    const ref = doc(db, 'artifacts', appUniqueId, 'public', 'data', 'inventory', id);
                    await runTransaction(db, async (t) => {
                        const snap = await t.get(ref);
                        if (!snap.exists()) throw "无此商品";
                        const d = snap.data();
                        const cq = Number(d.quantity)||0;
                        if (cq < q) throw "库存不足";
                        t.update(ref, { quantity: cq-q });
                        const ca = Number(d.avgCost)||0;
                        t.set(doc(collection(db, 'artifacts', appUniqueId, 'public', 'data', 'transactions')), { type: 'sale', inventoryId: id, brand: d.brand, spec: d.spec, quantity: q, price: p, totalPrice: p*q, costAtTime: ca, profit: (p-ca)*q, date: new Date().toISOString(), timestamp: Date.now(), operator: user.name });
                    });
                    showNotify("销售成功");
                } catch (e) { showNotify(typeof e==='string'?e:"销售失败", "error"); }
            };

            const handleService = async (type, qty, price) => {
                try {
                    await addDoc(collection(db, 'artifacts', appUniqueId, 'public', 'data', 'transactions'), { type: 'service', serviceName: type, quantity: parseInt(qty), totalPrice: parseFloat(price), profit: parseFloat(price), date: new Date().toISOString(), timestamp: Date.now(), operator: user.name });
                    showNotify("服务记录成功");
                } catch (e) { showNotify("记录失败", "error"); }
            };

            const handleUndo = async (tx) => {
                if (Date.now()-tx.timestamp > UNDO_TIME_LIMIT_MS && user.role !== 'boss') { showNotify("超时无法撤回", "error"); return; }
                try {
                    await runTransaction(db, async (t) => {
                        if (tx.type==='sale' && tx.inventoryId) {
                            const r = doc(db, 'artifacts', appUniqueId, 'public', 'data', 'inventory', tx.inventoryId);
                            const s = await t.get(r);
                            if (s.exists()) t.update(r, { quantity: (Number(s.data().quantity)||0)+tx.quantity });
                        }
                        if (tx.type==='stock_in') {
                            const bid = `${tx.brand}_${tx.spec}`.replace(/[\s/]+/g, '_').toUpperCase();
                            const r = doc(db, 'artifacts', appUniqueId, 'public', 'data', 'inventory', bid);
                            const s = await t.get(r);
                            if(s.exists()){ const cq = Number(s.data().quantity)||0; if(cq<tx.quantity) throw "库存不足无法撤回"; t.update(r,{quantity: cq-tx.quantity}); }
                        }
                        t.delete(doc(db, 'artifacts', appUniqueId, 'public', 'data', 'transactions', tx.id));
                    });
                    showNotify("已撤销");
                } catch(e) { showNotify(typeof e==='string'?e:"撤销失败", "error"); }
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">加载中...</div>;
            if (bossLocked) return <BossLockScreen onUnlock={p => p===BOSS_PIN?(setBossLocked(false),showNotify("解锁")) : showNotify("密码错误","error")} onSwitchUser={handleLogout} />;
            if (showLogin) return <LoginScreen onLoginSuccess={handleLoginSuccess} showNotify={showNotify} db={db} />;

            return (
                <div className="min-h-screen pb-safe">
                    {notification && <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-xl text-white font-medium animate-in fade-in slide-in-from-top-4 ${notification.type==='error'?'bg-red-500':'bg-emerald-500'} max-w-[90vw] text-center`}>{notification.msg}</div>}
                    <header className="bg-slate-900 text-white sticky top-0 z-40 shadow-lg px-4 py-4 flex justify-between items-center"><div className="flex items-center gap-3"><div className="bg-blue-600 p-2 rounded-lg shrink-0"><Users size={20}/></div><div><h1 className="font-bold text-lg">许氏轮胎店</h1><p className="text-xs text-slate-400">{user.role==='boss'?'老板端':'员工端'} · {user.name}</p></div></div><button onClick={handleLogout} className="text-slate-400 hover:text-white p-2"><LogOut size={20}/></button></header>
                    <main className="max-w-3xl mx-auto p-4 space-y-6">
                        <nav className="fixed bottom-0 left-0 right-0 bg-white border-t p-2 z-30 pb-safe md:relative md:border-0 md:p-0"><div className="max-w-3xl mx-auto grid grid-cols-3 gap-2">
                            <NavBtn active={currentTab==='dashboard'} onClick={()=>setCurrentTab('dashboard')} icon={TrendingUp} label="概览"/>
                            <NavBtn active={currentTab==='operate'} onClick={()=>setCurrentTab('operate')} icon={Wrench} label="记账"/>
                            {user.role==='boss'?<NavBtn active={currentTab==='inventory'} onClick={()=>setCurrentTab('inventory')} icon={PackagePlus} label="仓库"/>:<NavBtn active={currentTab==='history'} onClick={()=>setCurrentTab('history')} icon={History} label="记录"/>}
                        </div></nav>
                        {currentTab==='dashboard' && <DashboardView user={user} txs={transactions} inv={inventory} showNotify={showNotify} db={db} />}
                        {currentTab==='operate' && <OperateView user={user} inv={inventory} onSale={handleSale} onService={handleService} />}
                        {currentTab==='inventory' && <InventoryView inv={inventory} onStockIn={handleStockIn} />}
                        {currentTab==='history' && <HistoryView user={user} txs={transactions} onUndo={handleUndo} />}
                    </main>
                </div>
            );
        }

        // --- Sub Components ---
        const LoginScreen = ({ onLoginSuccess, showNotify, db }) => {
            const [tab, setTab] = useState('login');
            const [name, setName] = useState("");
            const [pass, setPass] = useState("");
            const [loading, setLoading] = useState(false);
            const [mode, setMode] = useState(null);

            const handleLogin = async () => {
                if (mode === 'boss') {
                    if (pass === BOSS_PIN) onLoginSuccess({ name: 'Boss', role: 'boss' });
                    else showNotify("密码错误", "error");
                    return;
                }
                if (!name || !pass) return;
                setLoading(true);
                try {
                    const snap = await getDoc(doc(db, 'artifacts', appUniqueId, 'public', 'data', 'users', name));
                    if (!snap.exists()) showNotify("账号不存在", "error");
                    else {
                        const d = snap.data();
                        if (d.password !== pass) showNotify("密码错误", "error");
                        else if (d.status !== 'approved') showNotify("账号审核中或被拒", "error");
                        else onLoginSuccess({ name: d.name, role: 'employee' });
                    }
                } catch(e) { showNotify("登录失败: "+e.message, "error"); }
                setLoading(false);
            };

            const handleReg = async () => {
                if (!name || !pass) return;
                setLoading(true);
                try {
                    const ref = doc(db, 'artifacts', appUniqueId, 'public', 'data', 'users', name);
                    const snap = await getDoc(ref);
                    if (snap.exists()) showNotify("用户已存在", "error");
                    else {
                        await setDoc(ref, { name, password: pass, role: 'employee', status: 'pending', createdAt: new Date().toISOString() });
                        showNotify("申请已提交"); setTab('login');
                    }
                } catch(e) { showNotify("注册失败", "error"); }
                setLoading(false);
            };

            if (!mode) return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 space-y-8">
                    <div className="text-center"><div className="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-2"><Users className="text-white w-8 h-8"/></div><h1 className="text-3xl font-bold text-white">许氏轮胎店</h1></div>
                    <div className="w-full max-w-sm space-y-4">
                        <button onClick={()=>setMode('employee')} className="bg-white p-6 rounded-xl flex justify-between items-center w-full active:scale-95 transition-transform"><div className="flex gap-4 items-center"><div className="bg-blue-100 p-3 rounded text-blue-600"><Wrench/></div><div className="text-left"><div className="font-bold">我是员工</div><div className="text-sm text-slate-500">记账/查询</div></div></div><ArrowRight className="text-slate-300"/></button>
                        <button onClick={()=>setMode('boss')} className="bg-slate-800 border border-slate-700 text-white p-6 rounded-xl flex justify-between items-center w-full active:scale-95 transition-transform"><div className="flex gap-4 items-center"><div className="bg-slate-700 p-3 rounded text-slate-300"><ShieldCheck/></div><div className="text-left"><div className="font-bold">我是老板</div><div className="text-sm text-slate-400">管理/利润</div></div></div><ArrowRight className="text-slate-600"/></button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
                    <Card className="w-full max-w-sm">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 text-center">{mode==='employee'?'员工入口':'老板入口'}</h2>
                        {mode === 'employee' && (
                            <div className="flex border-b mb-4">
                                <button onClick={()=>setTab('login')} className={`flex-1 pb-2 font-bold border-b-2 transition-colors ${tab==='login'?'border-blue-600 text-blue-600':'border-transparent text-slate-400'}`}>登录</button>
                                <button onClick={()=>setTab('reg')} className={`flex-1 pb-2 font-bold border-b-2 transition-colors ${tab==='reg'?'border-blue-600 text-blue-600':'border-transparent text-slate-400'}`}>注册</button>
                            </div>
                        )}
                        <div className="space-y-4">
                            {mode==='boss' ? (
                                <Input label="管理员密码" type="password" value={pass} onChange={setPass} inputMode="numeric" placeholder="输入 PIN 码"/>
                            ) : (
                                <>
                                    <Input label="姓名" value={name} onChange={setName} placeholder="您的名字"/>
                                    <Input label="密码" type="password" value={pass} onChange={setPass} placeholder="设置密码"/>
                                </>
                            )}
                            <Button onClick={tab==='login'||mode==='boss'?handleLogin:handleReg} disabled={loading}>{loading?'处理中...':(tab==='login'||mode==='boss'?'进入系统':'提交申请')}</Button>
                        </div>
                        <button onClick={()=>{setMode(null);setName("");setPass("")}} className="w-full text-center text-sm text-slate-400 mt-4 p-2">返回选择</button>
                    </Card>
                </div>
            );
        };

        const BossLockScreen = ({ onUnlock, onSwitchUser }) => {
            const [p, setP] = useState("");
            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6">
                    <Card className="w-full max-w-sm text-center">
                        <div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Lock className="w-8 h-8 text-slate-600"/></div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">欢迎回来</h2>
                        <p className="text-slate-500 mb-6">请输入密码解锁</p>
                        <Input type="password" value={p} onChange={setP} inputMode="numeric" placeholder="密码"/>
                        <Button onClick={()=>onUnlock(p)} className="mb-4">解锁</Button>
                        <button onClick={onSwitchUser} className="text-slate-400 text-sm p-2">切换账号</button>
                    </Card>
                </div>
            );
        };

        const StaffManager = ({ showNotify }) => {
            const [pending, setPending] = useState([]);
            useEffect(() => {
                return onSnapshot(query(collection(db, 'artifacts', appUniqueId, 'public', 'data', 'users'), where("status", "==", "pending")), 
                (snap) => setPending(snap.docs.map(d => d.data())));
            }, []);
            const handle = async (name, ok) => {
                await updateDoc(doc(db, 'artifacts', appUniqueId, 'public', 'data', 'users', name), { status: ok ? 'approved' : 'rejected' });
                showNotify(ok ? `已批准 ${name}` : `已拒绝 ${name}`);
            };
            if (!pending.length) return null;
            return (
                <Card className="border-blue-200 bg-blue-50 mb-6">
                    <div className="flex items-center gap-2 mb-3 text-blue-800 font-bold"><UserPlus size={20}/><h3>新员工审核 ({pending.length})</h3></div>
                    <div className="space-y-2">{pending.map(u => (
                        <div key={u.name} className="flex justify-between bg-white p-3 rounded-lg shadow-sm">
                            <span className="font-bold">{u.name}</span>
                            <div className="flex gap-2"><button onClick={() => handle(u.name, true)} className="text-emerald-500 p-2"><CheckCircle/></button><button onClick={() => handle(u.name, false)} className="text-red-500 p-2"><XCircle/></button></div>
                        </div>
                    ))}</div>
                </Card>
            );
        };

        const DashboardView = ({ user, txs, inv, showNotify, db }) => {
            const today = new Date().toDateString();
            const todayTx = txs.filter(t => new Date(t.date).toDateString() === today);
            const stats = useMemo(() => {
                let r = 0, p = 0, c = 0;
                todayTx.forEach(t => {
                    if (user.role !== 'boss' && t.operator !== user.name) return;
                    if (t.type === 'sale' || t.type === 'service') { r += (t.totalPrice||0); c += (t.quantity||0); if (user.role === 'boss') p += (t.profit||0); }
                });
                return { r, p, c };
            }, [todayTx, user]);
            const lowStock = inv.filter(i => (Number(i.quantity)||0) < 4);

            return (
                <div className="space-y-6">
                    {user.role === 'boss' && <StaffManager showNotify={showNotify} />}
                    <div className="grid grid-cols-2 gap-4">
                        <StatCard label="今日营业额" value={`¥${stats.r}`} color="blue" />
                        <StatCard label="今日单量" value={`${stats.c} 单`} color="slate" />
                        {user.role === 'boss' && <StatCard label="今日毛利" value={`¥${stats.p}`} color="emerald" fullWidth />}
                    </div>
                    {user.role === 'boss' && lowStock.length > 0 && (
                        <Card className="border-orange-200 bg-orange-50">
                            <div className="flex gap-2 mb-2 text-orange-800 font-bold"><AlertTriangle size={20}/><h3>库存预警</h3></div>
                            <div className="space-y-2">{lowStock.map(i => <div key={i.id} className="flex justify-between text-sm bg-white/50 p-2 rounded"><span>{i.brand} {i.spec}</span><span className="font-bold text-red-600">余 {i.quantity}</span></div>)}</div>
                        </Card>
                    )}
                    <div>
                        <h3 className="font-bold text-slate-700 mb-3 flex justify-between items-center"><span>今日记录</span><span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded-full">{today}</span></h3>
                        <TxList txs={todayTx.filter(t => user.role === 'boss' || t.operator === user.name)} showProfit={user.role === 'boss'} />
                    </div>
                </div>
            );
        };

        const OperateView = ({ user, inv, onSale, onService }) => {
            const [tab, setTab] = useState('sale');
            const [sid, setSid] = useState("");
            const [sq, setSq] = useState("");
            const [sp, setSp] = useState("");
            const [st, setSt] = useState("补胎");
            const [svq, setSvq] = useState("");
            const [svp, setSvp] = useState("");
            const item = inv.find(i => i.id === sid);

            return (
                <div className="space-y-4">
                    <div className="flex p-1 bg-slate-200 rounded-xl">
                        <button onClick={() => setTab('sale')} className={`flex-1 py-2 font-bold rounded-lg ${tab === 'sale' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>换胎</button>
                        <button onClick={() => setTab('service')} className={`flex-1 py-2 font-bold rounded-lg ${tab === 'service' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>补胎</button>
                    </div>
                    <Card>
                        {tab === 'sale' ? (
                            <div className="space-y-4">
                                <div className="flex flex-col gap-1">
                                    <label className="text-xs font-semibold text-slate-500 uppercase">选择轮胎</label>
                                    <select className="w-full p-3 border border-slate-200 rounded-lg bg-white h-12 text-base" value={sid} onChange={e => setSid(e.target.value)} style={{fontSize:'16px'}}>
                                        <option value="">-- 请选择 --</option>
                                        {inv.map(i => <option key={i.id} value={i.id} disabled={i.quantity<=0}>{i.brand} {i.spec} (余:{i.quantity})</option>)}
                                    </select>
                                </div>
                                {item && <div className="bg-blue-50 text-blue-800 text-xs p-2 rounded">当前库存: {item.quantity}</div>}
                                <div className="grid grid-cols-2 gap-4"><Input label="数量" type="number" value={sq} onChange={setSq} inputMode="decimal" /><Input label="单价" type="number" value={sp} onChange={setSp} inputMode="decimal" /></div>
                                <div className="bg-slate-50 p-3 rounded flex justify-between"><span className="text-slate-500">总计:</span><span className="font-bold text-lg">¥{((parseFloat(sq)||0)*(parseFloat(sp)||0)).toFixed(0)}</span></div>
                                <Button onClick={() => { onSale(sid, sq, sp); setSid(""); setSq(""); setSp(""); }} disabled={!sid || !sq || !sp}>确认销售</Button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="flex flex-col gap-1"><label className="text-xs font-semibold text-slate-500 uppercase">服务类型</label><select className="w-full p-3 border border-slate-200 rounded-lg bg-white h-12 text-base" value={st} onChange={e => setSt(e.target.value)} style={{fontSize:'16px'}}>{["补胎","动平衡","四轮定位","充气"].map(o=><option key={o} value={o}>{o}</option>)}</select></div>
                                <Input label="数量" type="number" value={svq} onChange={setSvq} inputMode="decimal" /><Input label="总价" type="number" value={svp} onChange={setSvp} inputMode="decimal" />
                                <Button onClick={() => { onService(st, svq, svp); setSvq(""); setSvp(""); }} disabled={!svq || !svp}>确认记录</Button>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        const InventoryView = ({ inv, onStockIn }) => {
            const [open, setOpen] = useState(false);
            const [search, setSearch] = useState("");
            const [brand, setBrand] = useState("");
            const [spec, setSpec] = useState("");
            const [qty, setQty] = useState("");
            const [cost, setCost] = useState("");

            const handle = async () => {
                if (brand && spec && qty && cost) {
                    await onStockIn(brand, spec, qty, cost);
                    setOpen(false); setBrand(""); setSpec(""); setQty(""); setCost(""); setSearch("");
                }
            };
            const norm = s => (s||"").toLowerCase().replace(/[\s/]/g, "");
            const raw = search.toLowerCase().trim();
            const clean = norm(search);
            const list = inv.filter(i => !search || (i.brand||"").toLowerCase().includes(raw) || (i.spec||"").toLowerCase().includes(raw) || norm(i.spec).includes(clean));
            const totalQ = list.reduce((s, i) => s + (Number(i.quantity)||0), 0);
            const totalV = list.reduce((s, i) => s + ((Number(i.quantity)||0)*(Number(i.avgCost)||0)), 0);

            return (
                <div className="space-y-4">
                    <div className="flex gap-2"><div className="relative flex-1"><Search className="absolute left-3 top-3 text-slate-400 w-4 h-4"/><input className="w-full pl-9 p-3 border rounded-lg h-12 text-base" placeholder="搜品牌/规格" value={search} onChange={e=>setSearch(e.target.value)} style={{fontSize:'16px'}}/>{search && <button onClick={()=>setSearch('')} className="absolute right-3 top-3 text-slate-400"><X size={16}/></button>}</div><Button onClick={()=>setOpen(true)}><Plus size={20}/></Button></div>
                    {(search || list.length > 0) && <div className="grid grid-cols-2 gap-4 bg-slate-100 p-3 rounded-xl"><div className="text-center"><div className="text-xs text-slate-500">总数</div><div className="font-bold text-lg">{totalQ}</div></div><div className="text-center"><div className="text-xs text-slate-500">货值</div><div className="font-bold text-lg">¥{totalV.toLocaleString()}</div></div></div>}
                    <div className="bg-white rounded-xl border overflow-hidden">
                        <table className="w-full text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-3 text-left">信息</th><th className="p-3 text-right">库存</th><th className="p-3 text-right">成本</th></tr></thead>
                        <tbody className="divide-y">{list.map(i => <tr key={i.id}><td className="p-3"><div className="font-bold">{i.brand}</div><div className="text-xs text-slate-500">{i.spec}</div></td><td className={`p-3 text-right font-bold ${(Number(i.quantity)||0)<4?'text-red-500':''}`}>{i.quantity}</td><td className="p-3 text-right text-slate-500">¥{(i.avgCost||0).toFixed(0)}</td></tr>)}</tbody></table>
                        {!list.length && <div className="p-8 text-center text-slate-400">暂无数据</div>}
                    </div>
                    <Modal isOpen={open} onClose={()=>setOpen(false)} title="入库"><Input label="品牌" value={brand} onChange={setBrand}/><Input label="规格" value={spec} onChange={setSpec}/><div className="grid grid-cols-2 gap-4"><Input label="数量" type="number" value={qty} onChange={setQty}/><Input label="单价" type="number" value={cost} onChange={setCost}/></div><Button onClick={handle} className="w-full mt-4" disabled={!brand||!spec||!qty||!cost}>确认入库</Button></Modal>
                </div>
            );
        };

        const HistoryView = ({ user, txs, onUndo }) => {
            return (
                <div className="space-y-4">
                    <h3 className="font-bold text-slate-700">历史记录</h3>
                    <TxList txs={user.role === 'boss' ? txs : txs.filter(t => t.operator === user.name)} showProfit={user.role === 'boss'} onUndo={onUndo} user={user} />
                </div>
            );
        };

        const TxList = ({ txs, showProfit, onUndo, user }) => {
            if (!txs.length) return <div className="text-center py-8 text-slate-400">暂无记录</div>;
            return (
                <div className="space-y-3">
                    {txs.map(t => {
                        const canUndo = onUndo && (user.role === 'boss' || (Date.now() - t.timestamp < UNDO_TIME_LIMIT_MS));
                        return (
                            <div key={t.id} className="bg-white p-3 rounded-xl border flex justify-between items-center">
                                <div className="flex gap-3 items-center flex-1 min-w-0">
                                    <div className={`p-2 rounded-lg shrink-0 ${t.type==='stock_in'?'bg-purple-100 text-purple-600':t.type==='sale'?'bg-blue-100 text-blue-600':'bg-emerald-100 text-emerald-600'}`}>{t.type==='stock_in'?<PackagePlus size={20}/>:t.type==='sale'?<Minus size={20}/>:<Wrench size={20}/>}</div>
                                    <div className="min-w-0 truncate"><div className="font-bold text-sm truncate">{t.type==='stock_in'?`进货: ${t.brand}`:t.type==='sale'?`销售: ${t.brand}`:t.serviceName}</div><div className="text-xs text-slate-500 truncate">{t.spec && <span>{t.spec} </span>} {t.quantity && <span>x{t.quantity}</span>} <span className="ml-1">{new Date(t.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} · {t.operator}</span></div></div>
                                </div>
                                <div className="text-right shrink-0 ml-2">
                                    <div className="font-bold">¥{t.type==='stock_in'?t.totalCost:t.totalPrice}</div>
                                    {showProfit && t.profit!=null && <div className="text-xs text-emerald-600 font-medium">赚 ¥{t.profit.toFixed(0)}</div>}
                                    {canUndo && <button onClick={()=>{if(confirm("确定撤销?"))onUndo(t)}} className="text-xs text-red-400 mt-1 flex items-center gap-1 justify-end p-1 -mr-1"><Trash2 size={12}/>撤销</button>}
                                </div>
                            </div>
                        )
                    })}
                </div>
            );
        };

        const NavBtn = ({ active, onClick, icon: Icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center p-2 rounded-xl transition-colors ${active ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}><Icon className={`w-6 h-6 mb-1 ${active?'fill-current':''}`}/><span className="text-xs font-medium">{label}</span></button>
        );
        const StatCard = ({ label, value, color, fullWidth }) => (
            <Card className={`text-center ${fullWidth?'col-span-2':''}`}><div className="text-xs font-semibold text-slate-400 uppercase mb-1">{label}</div><div className={`text-2xl font-bold text-${color}-600`}>{value}</div></Card>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<Main />);
    </script>
</body>
</html>
